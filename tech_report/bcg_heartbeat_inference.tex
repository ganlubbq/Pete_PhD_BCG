\documentclass{article}

%%% Packages %%%

% Graphics
\usepackage{graphicx}
\usepackage[caption=false,font=footnotesize]{subfig}

% Formatting
\usepackage{color}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{amsfonts}
\usepackage{bbm}
\usepackage[T1]{fontenc}

% Environments
\usepackage{IEEEtrantools}
\usepackage{algorithm}
\usepackage{algorithmic}

% References
\usepackage{natbib}

% Macro
\usepackage{etoolbox}


%%% Graphics %%%
\graphicspath{{figures/}}


%%% Macros %%%
\input{bcg_heartbeat_inference_macros}


%%% Environments %%%
\newenvironment{meta}[0]{\color{red} \em}{}
\newtheorem{lemma}{Lemma}


%%% Titles and stuff %%%
\title{Variable Rate Algorithms for Inference of Heartbeats in a Balistocardiography Signal}
\author{Pete Bunch}


%%% DOCUMENT %%%
\begin{document}

\maketitle

\section{Introduction}



\section{Variable Rate Models}

Consider a set of observations $\ob{1:\timax} = \{\ob{1} \dots \ob{\timax}\}$ made at times $\ot{1:\timax}$ of some underlying continuously-varying latent state $\cls{\ct}$. The dynamics of this latent state are dependent on a sequence of changepoints occurring at instantaneous moments in continuous time, each with an associated parameter. The changepoints are divided into a number of separate sub-sequence, each with its own dynamics. The time and parameter of the $(\cpi)$th changepoint in the $(\sqi)$th sub-sequence are denoted $\cpt[\sqi]{\cpi}$ and $\cpp[\sqi]{\cpi}$ respectively.

Here we assume that the sub-sequences are independent a priori, and the changepoints of the $(\sqi)$th sub-sequence are modelled as Markovian with a transition density,
%
\begin{IEEEeqnarray}{rCl}
 \left\{ \cpt[\sqi]{\cpi}, \cpp[\sqi]{\cpi} \right\} & \sim & \transden[\sqi]{\cpt{},\cpp{}}(\cpt[\sqi]{\cpi}, \cpp[\sqi]{\cpi} | \cpt[\sqi]{\cpi-1}, \cpp[\sqi]{\cpi-1}) \nonumber      ,
\end{IEEEeqnarray}

with this constructed such that $\prob(\cpt[\sqi]{\cpi} < \cpt[\sqi]{\cpi-1}) = 0$. Furthermore, the first changepoint has a prior density,
%
\begin{IEEEeqnarray}{rCl}
 \left\{ \cpt[\sqi]{0}, \cpp[\sqi]{0} \right\} & \sim & \transden[\sqi]{\cpt{},\cpp{}}(\cpt[\sqi]{0}, \cpp[\sqi]{0}) \nonumber      .
\end{IEEEeqnarray}
%
Note that a model in which the changepoint sequence is not Markovian may often be reformulated such that is by including extra changepoint parameters which are set (deterministically or stochastically) depending on previous values. For example, the parameter could store the times of a fixed number of the most recent changepoints.

Following \citep{Whiteley2011}, a survivor function is defined for the probability that no new changepoint occurs before a given time,
%
\begin{IEEEeqnarray}{rCl}
 \survfunc[\sqi]{\cpt{\cpi}}{\cpp{\cpi}}{\ct} & = & \prob(\cpt[\sqi]{\cpi+1} > \ct | \cpt{\cpi}, \cpp{\cpi}) \nonumber \\
 & = & 1 - \int_{\cpt{\cpi}}^{\ct} \transden[\sqi]{\cpt{}}(\xi | \cpt{\cpi}, \cpp{\cpi}) \nonumber      .
\end{IEEEeqnarray}

A final piece of notation, the following counting variables are introduced to keep track of the most recent changepoint to have occurred,
%
\begin{IEEEeqnarray}{rCl}
 \cmrcpi[\sqi]{\ct} & = & \max(\cpi : \cpt[\sqi]{\cpi}<\ct) \nonumber \\
 \dmrcpi[\sqi]{\ti} & = & \cmrcpi[\sqi]{\ot{\ti}} \nonumber      .
\end{IEEEeqnarray}

Inference algorithms for variable rate models will require us to manipulate and calculate probabilities for sets of changepoints. To this end, we define the following variable for the complete set of changepoint times and parameters occurring between two of the observation instants,
%
\begin{IEEEeqnarray}{rCl}
 \cp[\ti_1]{\ti_2} & = & \left\{\cpt[\sqi]{j}, \cpp[\sqi]{j} \: \forall j, \sqi : \ot{\ti_1} < \cpt[\sqi]{j} \leq \ot{\ti_2} \right\} \nonumber      .
\end{IEEEeqnarray}
%
and likewise for the set occurring before a given instant,
%
\begin{IEEEeqnarray}{rCl}
 \cp{\ti} = \left\{\cpt[\sqi]{j}, \cpp[\sqi]{j} \: \forall j, \sqi : \cpt[\sqi]{j} \leq \ot{\ti} \right\} \nonumber      .
\end{IEEEeqnarray}

Each changepoint sequence constitutes a finite-duration marked point process, taking values in the space formed by the disjoint union (sub-sequence superscripts suppressed for clarity),
%
\begin{IEEEeqnarray}{rCl}
 \cpspace[\ti_1]{\ti_2} & = & \bigcup_l \{l\} \times \cptspace[\ti_1]{\ti_2,l} \times \cppspace^l \nonumber      ,
\end{IEEEeqnarray}
%
where $\cppspace$ is the space of $\cpp{\cpi}$ and $\cptspace[\ti_1]{\ti_2,l} \subset \reals^l$ is the space spanned by $l$ changepoint times subject to the conditions that they all lie in the interval $[\ot{\ti_1},\ot{\ti_2}]$ and that each is greater than its predecessor.

A rigorous treatment of probability distributions over marked point processes may be found in \citep{Jacobsen2006}. We can write the conditional distribution for a changepoint sequence,
%
\begin{IEEEeqnarray}{rCl}
 \transden{\cp{}}(\cp[\ti_1]{\ti_2} | \cp{\ti_1})  & = & \prod_{\sqi}\left\{ \frac{ \survfunc[\sqi]{\cpt[\sqi]{\dmrcpi[\sqi]{\ti_2}}}{\cpp[\sqi]{\dmrcpi[\sqi]{\ti_2}}}{\ot{\ti_2}} }{ \survfunc[\sqi]{\cpt[\sqi]{\dmrcpi[\sqi]{\ti_1}}}{\cpp[\sqi]{\dmrcpi[\sqi]{\ti_1}}}{\ot{\ti_1}} } \prod_{\cpi=\dmrcpi[\sqi]{\ti_1}+1}^{\dmrcpi[\sqi]{\ti_2}} \transden[\sqi]{\cpt{},\cpp{}}(\cpt[\sqi]{\cpi}, \cpp[\sqi]{\cpi} | \cpt[\sqi]{\cpi-1}, \cpp[\sqi]{\cpi-1}) \right\} \nonumber       .
\end{IEEEeqnarray}
%
When formulating the prior distribution for a changepoint sequence, we condition on the fact that $\cpt[\sqi]{0} < \ot{1}$ and $\cpt[\sqi]{1} > \ot{1}$. This excludes from consideration the infinitude of possible changepoint sequences in which the start of the sequence does not align with the start of the observations. This conditioning will not be written out explicitly. Hence,
%
\begin{IEEEeqnarray}{rCl}
 \transden{\cp{}}(\cp{\ti}) & = & \prod_{\sqi}\left\{ \survfunc[\sqi]{\cpt[\sqi]{\dmrcpi[\sqi]{\ti}}}{\cpp[\sqi]{\dmrcpi[\sqi]{\ti}}}{\ot{\ti}} \transden[\sqi]{\cpt{},\cpp{}}(\cpt[\sqi]{0}, \cpp[\sqi]{0} | \cpt[\sqi]{0} < \ot{1}, \cpt[\sqi]{1} > \ot{1}) \prod_{\cpi=1}^{\dmrcpi[\sqi]{\ti}} \transden[\sqi]{\cpt{},\cpp{}}(\cpt[\sqi]{\cpi}, \cpp[\sqi]{\cpi} | \cpt[\sqi]{\cpi-1}, \cpp[\sqi]{\cpi-1}, \cpt[\sqi]{1} > \ot{1}) \right\} \nonumber \\
 & \propto & \begin{cases}
         \prod_{\sqi}\left\{ \frac{ \survfunc[\sqi]{\cpt[\sqi]{\dmrcpi[\sqi]{\ti}}}{\cpp[\sqi]{\dmrcpi[\sqi]{\ti}}}{\ot{\ti}} }{ \survfunc[\sqi]{\cpt[\sqi]{\dmrcpi[\sqi]{0}}}{\cpp[\sqi]{\dmrcpi[\sqi]{0}}}{\ot{1}} } \transden[\sqi]{\cpt{},\cpp{}}(\cpt[\sqi]{0}, \cpp[\sqi]{0}) \prod_{\cpi=1}^{\dmrcpi[\sqi]{\ti}} \transden[\sqi]{\cpt{},\cpp{}}(\cpt[\sqi]{\cpi}, \cpp[\sqi]{\cpi} | \cpt[\sqi]{\cpi-1}, \cpp[\sqi]{\cpi-1}) \right\}, & \cpt[\sqi]{0} < \ot{1}, \cpt[\sqi]{1} > \ot{1} \\
         0, & \text{otherwise}
       \end{cases} \nonumber      ,
\end{IEEEeqnarray}
%
where the proportionality factor is $\left[\prod_{\sqi} \prob(\cpt[\sqi]{0} < \ot{1}, \cpt[\sqi]{1} > \ot{1})\right]^{-1}$. It is possible to sample from this prior. Taking each sub-sequence in turn, changepoints are sampled successively until one falls after $\ot{\ti}$. This last one is discarded. The initial changepoint density for each sequence $\transden[\sqi]{\cpt{},\cpp{}}(\cpt[\sqi]{0}, \cpp[\sqi]{0} | \cpt[\sqi]{0} < \ot{1}, \cpt[\sqi]{1} > \ot{1})$ may be sampled using rejection sampling.

%Alternatively, if $\cpt{0}$ and $\cpp{0}$ are independent, and the changepoint transition model is of the form,
%%
%\begin{IEEEeqnarray}{rCl}
% \cpt{\cpi+1} & = & \cpt{\cpi} + \cpdiff{\cpi} \nonumber \\
% \cpdiff{\cpi} & \sim & \transden{\cpdiff}(\cpdiff{\cpi} | \cpp{\cpi}) \nonumber      ,
%\end{IEEEeqnarray}
%%
%then exact sampling is possible, by first drawing $\cpp{0}$ from the prior, then $\cpdiff{0}$, and finally,
%%
%\begin{IEEEeqnarray}{rCl}
% \cpt{0} & \sim & \begin{cases}
%                    \transden
%                  \end{cases}
%\end{IEEEeqnarray}



\subsection{State Dynamics and Observation Likelihoods}

The latent state is a continuous-time process denoted $\cls{\ct} \in \lsspace$ which evolves according to some benign dynamics conditional upon the changepoint sequence. In this paper we consider only one of several possible classes of state dynamics which encompasses the various balistocardiography models introduced. Sub-sequence superscripts are omitted for clarity in this section.

In our BCG models, the latent state evolution is governed by the changepoint sequence alongside an additional set of auxiliary variables. There will be one auxiliary variable $\cplp{\cpi}$ corresponding to each changepoint time $\cpt{\cpi}$. This new variable is distinguished from the existing changepoint parameter by the fact that it evolves according to a linear Gauss-Markov model,
%
\begin{IEEEeqnarray}{rCl}
 \transden{\cplp{}}(\cplp{\cpi} | \cpt{0:\cpi}, \cpp{0:\cpi}, \cplp{0:\cpi-1}) & = & \normalden{\cplp{\cpi}}{\cplptransmat \cplp{\cpi}}{\cplptranscov} \nonumber \\
 \transden{\cplp{}}(\cplp{0}) & = & \normalden{\cplp{\cpi}}{\cplpmn{0}}{\cplpvr{0}} \nonumber      ,
\end{IEEEeqnarray}

Conditional upon the changepoint sequence, the state is a deterministic linear function of the most recent auxiliary variable,
%
\begin{IEEEeqnarray}{rCl}
 \cls{\ct} & = & \transfun(\ct) \cplp{\cmrcpi{\ct}} \nonumber      .
\end{IEEEeqnarray}

Finally, the dependence of the observations on the latent state is also linear and Gaussian,
%
\begin{IEEEeqnarray}{rCl}
 \lhood(\ob{\ti} | \cls{\ot{\ti}}) & = & \normalden{\ob{\ti}}{\obsmat \cls{\ot{\ti}}}{\obscov} \nonumber      .
\end{IEEEeqnarray}

The matrixes $\obsmat$, $\obscov$, $\cplptransmat$, $\cplptranscov$ may all be functions of $\cpt{0:\dmrcpi{\ti}}, \cpp{0:\dmrcpi{\ti}}$, and $\transfun(\ct)$ may be a function of $\cpt{0:\cmrcpi{\ct}}, \cpp{0:\cmrcpi{\ct}}$, but this is suppressed above for clarity.

Variable rate models with a similar structure were studied in \citep{Morelande2009a}.



\section{Variable Rate Block Filtering}

The analytic calculation of posterior distributions over the changepoint sequence is generally intractable. Instead, we resort to particle algorithms, in which each distribution is represented by a set of weighted particles sampled from it,
%
\begin{IEEEeqnarray}{rCl}
 p(\cp{\ti} | \ob{1:\ti}) & \approx & \sum_j \pw{\ti}\pss{j} \delta_{ \cp{\ti}\pss{j} }(\cp{\ti}) \nonumber      .
\end{IEEEeqnarray}
%
The state dynamical model is constructed so that $p(\cls{\ct}|\cp{\ti}, \ob{1:\ti})$ may be calculated analytically (for $\ct<\ot{\ti}$) --- this conditional posterior is commonly deterministic or Gaussian --- and hence the following approximation to the latent state distribution is made,
%
\begin{IEEEeqnarray}{rCll}
 p(\cls{\ct} | \ob{1:\ti}) & = & \int p(\cls{\ct}|\cp{\ti}\pss{j}, \ob{1:\ti}) p(\cp{\ti} | \ob{1:\ti}) d\cp{\ti} &, \qquad \ct < \ot{\ti} \nonumber \\
 & \approx & \sum_j \pw{\ti}\pss{j} p(\cls{\ct}|\cp{\ti}\pss{j}, \ob{1:\ti}) \nonumber      .
\end{IEEEeqnarray}

\subsection{Motivation}

The principal difficulty in devising inference algorithms for variable rate models is that changepoints are rarely apparent from the observations until a significant time after they have occurred. For example, when tracking a manoeuvering vehicle from measurements of its position, an abrupt change in its acceleration will not be evident until a sufficient deviation in course from its previous motion has accumulated. This phenomenon results in simpler particle filters, which at each time step extend the changepoint sequence from $\ot{\ti}$ to $\ot{\ti+1}$ in a straightforward manner \citep{Godsill2004a,Godsill2007}, to be quite ineffective in many cases. Performance may be substantially improved by allowing retrospective alterations to the changepoint sequence. This was achieved by \citet{Bunch2013} by including resample-move steps \citep{Gilks2001}, and by \citet{Whiteley2011} with the use of an SMC sampler \citep{DelMoral2006,Doucet2006}.

The obvious disadvantage of allowing retrospective alterations to the changepoint sequence is that the computational burden of the algorithm is substantially increased. With no restrictions on the permitted alterations, the complexity becomes $\bigo{\timax^2}$. By imposing a maximum window length spanning $\winlen$ observations, this may be reduced to $\bigo{\timax \times \winlen}$, but this may still be prohibitive. Here we propose an algorithm which abandons the requirement for the filter to update with the arrival of every new observation, but only once for each block of $\blocklen$. This reduces the complexity to $\bigo{\frac{\timax \times \winlen}{\blocklen}}$. The block length $\blocklen$ will be smaller than the window length $\winlen$ by a small factor (say $1.5$--$3$) meaning that there is still significant overlap between the windows of subsequent processing steps. Changepoints which occur late in the window at one processing step will be earlier in the window at the next step, and estimates may be revised in the light of the new observations received.

Apart from updating only once per block, the particle filter proposed here bears many similarities with the algorithm of \citet{Whiteley2011} but also the following important difference. We formulate proposals in terms of the changepoint sequence $\cp[\ot{\ti_1}]{\ot{\ti_2}}$, rather than by explicitly adjusting, adding or removing individual changepoints. Ultimately, these two systems can be seen as equivalent, but we find our framework better adapted to the types of proposals we wish to use. In particular, alterations to the number of changepoints in the window are more easily handled.

\subsection{Formulation}

In a particular processing step, the block particle filter targets the distribution $p(\cp{\ti+\winlen} | \ob{1:\ti+\winlen})$. A set of (weighted) particles is available from the previous processing step which approximate $p(\cp{\ti-\blocklen+\winlen} | \ob{1:\ti-\blocklen+\winlen})$. For the $(i)$th particle, the proposal begins by selecting one of those from the previous set with probability proportional to its weight (i.e. a resampling step), so that roughly,
%
\begin{IEEEeqnarray}{rCl}
 \cp{\ti-\blocklen+\winlen}\pss{i} & \sim & p(\cp{\ti-\blocklen+\winlen} | \ob{1:\ti-\blocklen+\winlen}) \nonumber      .
\end{IEEEeqnarray}
%
A new value is then sampled for the changepoint sequence between $\ot{\ti}$ and $\ot{\ti+\winlen}$ from an importance distribution,
%
\begin{IEEEeqnarray}{rCl}
 \repcp[\ti]{\ti+\winlen}\pss{i} & \sim & \impden{\ti}{\ti+\winlen}(\cp[\ti]{\ti+\winlen} | \cp{\ti-\blocklen+\winlen}\pss{i}) \nonumber      .
\end{IEEEeqnarray}

In order to avoid an intractable integral over the discarded changepoint sequence overlap, the target distribution is extended with an artificial conditional distribution, using the method introduced in \citep{DelMoral2006,Doucet2006},
%
\begin{IEEEeqnarray}{rCl}
 p(\cp{\ti}, \repcp[\ti]{\ti+\winlen} | \ob{1:\ti+\winlen}) \artden{\ti}{\ti-\blocklen+\winlen}( \cp[\ti]{\ti-\blocklen+\winlen} | \cp{\ti}, \repcp[\ti]{\ti+\winlen}) \nonumber      .
\end{IEEEeqnarray}

The resulting importance weight is given by the ratio,
%
\begin{IEEEeqnarray}{rCl}
 \pw{\ti}\pss{i} & = & \frac{ p(\cp{\ti}\pss{i}, \repcp[\ti]{\ti+\winlen}\pss{i} | \ob{1:\ti+\winlen}) \artden{\ti}{\ti-\blocklen+\winlen}( \cp[\ti]{\ti-\blocklen+\winlen}\pss{i} | \cp{\ti}\pss{i}, \repcp[\ti]{\ti+\winlen}\pss{i}) }{ p(\cp{\ti-\blocklen+\winlen}\pss{i} | \ob{1:\ti-\blocklen+\winlen}) \impden{\ti}{\ti+\winlen}(\repcp[\ti]{\ti+\winlen}\pss{i} | \cp{\ti-\blocklen+\winlen}\pss{i}) } \nonumber        ,
\end{IEEEeqnarray}
%
Having completed the importance sampling, the overlapping portion of each old sequence $\cp[\ti]{\ti-\blocklen+\winlen}\pss{i}$ is discarded, and the final particle is constructed,
%
\begin{IEEEeqnarray}{rCl}
 \cp{\ti+\winlen}\pss{i} \leftarrow \left\{ \cp{\ti}\pss{i}, \cp[\ti]{\ti+\winlen}\pss{i} \right\} \nonumber       .
\end{IEEEeqnarray}

A valid algorithm results whatever choice is made for $\artden{\ti}{\ti-\blocklen+\winlen}$, but some will lead to desirable lower variances of the importance weights.

\subsection{Evaluating the Likelihood}

For our particular auxiliary variable, conditionally-deterministic state dynamics, the model for the auxiliary variables is linear-Gaussian and Markovian when conditioned on the changepoint sequence. The conditional posterior distribution is thus Gaussian, and the parameters may be calculated analytically with a Kalman filter,
%
\begin{IEEEeqnarray}{rCl}
 p(\cplp{\dmrcpi{\ti}} | \cp{\ti}, \ob{1:\ti}) & = & \normalden{\cplp{\dmrcpi{\ti}}}{\cplpmn{\ti}}{\cplpvr{\ti}} \nonumber \\
 p(\cplp{\dmrcpi{\ti}} | \cp{\ti}, \ob{1:\ti-1}) & = & \normalden{\cplp{\dmrcpi{\ti}}}{\cplppredmn{\ti}}{\cplppredvr{\ti}} \nonumber      .
\end{IEEEeqnarray}
%
When progressing the Kalman filter from $\ot{\ti}$ to $\ot{\ti+1}$, a variable number of prediction steps occur, one for each changepoint present in the interval (which, in practice, will be either $0$ or $1$).

Using the Kalman filter moments, the marginal likelihood term required for the particle filter weight evaluation is given by,
%
\begin{IEEEeqnarray}{rCl}
 \lhood(\ob{\ti+1:\ti+\winlen} | \cp{\ti+\winlen}, \ob{1:\ti}) & = & \prod_l \lhood(\ob{\ti+l} | \cp{\ti+\winlen}, \ob{1:\ti+l-1}) \nonumber \\
 \lhood(\ob{\ti+l} | \cp{\ti+\winlen}, \ob{1:\ti+l-1}) & = & \int \lhood(\ob{\ti+l} | \cp{\ti+\winlen}, \cplp{\dmrcpi{\ti+l}}) \lhood(\cplp{\dmrcpi{\ti+l}} | \cp{\ti+\winlen}, \ob{1:\ti+l-1}) d\cplp{\dmrcpi{\ti+l}} \nonumber \\
 & = & \normalden{\ob{\ti+l}}{ \obsmat \transfun \cplppredmn{\ti+l} }{ \obsmat \transfun \cplppredvr{\ti+l} \transfun ^T\obsmat^T + \obscov } \nonumber      .
\end{IEEEeqnarray}

{\meta Add (or indeed replace this with) the single-step likelihood calculation using Gaussian concatenation. Possibly in an appendix considering the space it will take up.}



\subsection{Importance and Extension Distributions}

Although far from optimal, our first experiments will use the simplest options for both the importance and extension distributions, the transition densities for the respective sequences,
%
\begin{IEEEeqnarray}{rCl}
 \impden{\ti}{\ti+\winlen}(\repcp[\ti]{\ti+\winlen} | \cp{\ti-\blocklen+\winlen}) & = & \transden{\cp{}}(\repcp[\ti]{\ti+\winlen} | \cp{\ti}) \nonumber \\
 \artden{\ti}{\ti-\blocklen+\winlen}( \cp[\ti]{\ti-\blocklen+\winlen} | \cp{\ti}, \repcp[\ti]{\ti+\winlen}) & = & \transden{\cp{}}(\cp[\ti]{\ti-\blocklen+\winlen} | \cp{\ti}) \nonumber      .
\end{IEEEeqnarray}
%
With these choices we have,
%
\begin{IEEEeqnarray}{rCl}
 \pw{\ti}\pss{i} & \propto & \frac{ \lhood(\ob{\ti+1:\ti+\winlen} | \cp{\ti}\pss{i}, \repcp[\ti]{\ti+\winlen}\pss{i}, \ob{1:\ti}) }{ \lhood(\ob{\ti+1:\ti-\blocklen+\winlen} | \cp{\ti-\blocklen+\winlen}\pss{i}, \ob{1:\ti}) } \nonumber       .
\end{IEEEeqnarray}

An improved proposal method tailored to the heartbeat models is discussed in section~\ref{}{\meta Add ref.}



\section{Variable Rate Models for Balistocardiography}

\subsection{System Outline}

The balistocardiography (BCG) system under consideration consists of four force sensors placed under the legs of a bed, which are capable of recording the vibration caused by the subject's beating heart. Robust detection of the heartbeats in this signal is, however, a challenging problem. The heartbeat waveforms reaching the sensors exhibit significant variation depending on the bed, the subject, the position in which they lie, and many other factors. Moreover, these waveforms do not often possess a clear principal peak from which beat timings may be extracted, as an electrocardiography (ECG) signal often does. In addition, the signal is corrupted by frequent interference arising from the subject moving. Finally, the task becomes much more difficult when there are two people lying in the bed together. The sensors now measure a combination of two heartbeat signals which must be separated in parallel as the timings are inferred. The BCG inference task fits naturally into the variable rate framework, which heartbeat times corresponding to changepoints.

{\meta Add some examples.}



\subsection{Preprocessing}

The measurements from the four sensors are first low-pass filtered with a cut-off frequency of $15Hz$, and then down-sampled to $30Hz$. Another filter is used to remove the D.C. bias.



\subsection{The Basic Model}

We first consider a simple case: one person in the bed and no disturbances.

The start time of the $(\cpi)$th beat is denoted $\hbst{\cpi}$. The start of the next beat is assumed to have a shifted gamma distribution with some variable minimum beat duration $\hbmd{\cpi}$. The minimum beat duration is also modelled as gamma distributed with a mean equal to the value from the previous beat. Hence,
%
\begin{IEEEeqnarray}{rCl}
 \transden{\hbst{},\hbmd{}}( \hbst{\cpi+1}, \hbmd{\cpi+1} | \hbst{\cpi}, \hbmd{\cpi} ) & = & \gammaden{\hbst{\cpi+1}-\hbst{\cpi}-\hbmd{\cpi}}{\gamshape{\hbst{}}}{\gamscale{\hbst{}}} \gammaden{\hbmd{\cpi+1}}{\frac{\hbmd{\cpi}}{\gamscale{\hbmd{}}}}{\gamscale{\hbmd{}}} \nonumber      ,
\end{IEEEeqnarray}
%
where $\gammaden{x}{a}{b}$ represents a gamma density for $x$ with shape and scale parameters $a$ and $b$ respectively. $\gamshape{\hbst{}}$, $\gamscale{\hbst{}}$ and $\gamscale{\hbmd{}}$ are fixed parameters.

The latent state is a four-dimensional quantity representing the noise-free vibration signal reaching each of the four sensors. Associated with each heartbeat and each sensor we introduce a waveform template variable $\hbwf{\si,\cpi}$. This is a vector of points parameterising the continuous-time waveform. If the waveform were known a priori, the discrete template could be obtained by sampling it at the same rate as the observations. The signal at some arbitrary time during the beat $\hbst{\cpi} < t \leq \hbst{\cpi+1}$ is then specified deterministically by linear basis-function interpolation between these points,
%
\begin{IEEEeqnarray}{rCl}
 \hs{\si}{\ct} & = & \intrp(\hbst{\cmrcpi{\ct}},\ct) \cdot \hbwf{\si,\cmrcpi{\ct}} \nonumber      ,
\end{IEEEeqnarray}
%
where $\hs{\si}{\ct}$ is the $(\si)$th component of $\hs{}{\ct}$, and $\intrp(\hbst{\cpi},\ct)$ is a vector of interpolation factors. For example, using sinc interpolation,
%
\begin{IEEEeqnarray}{rCl}
 \intrp_{i}(\hbst{\cpi},\ct) & = & \sinc\left( \frac{\ct-\hbst{\cpi}- i \period}{\period} \right) \nonumber     ,
\end{IEEEeqnarray}
%
where $\period$ is the sampling period and $\hbwflen$ is the length of $\hbwf{\si,\cpi}$. Concatenating the state components, we have,
%
\begin{IEEEeqnarray}{rCl}
 \hs{}{\ct} & = & \underbrace{\begin{bmatrix} \intrp(\hbst{\cmrcpi{\ct}},\ct)^T & 0 & 0 & 0 \\ 0 & \intrp(\hbst{\cmrcpi{\ct}},\ct)^T & 0 & 0 \\ 0 & 0 & \intrp(\hbst{\cmrcpi{\ct}},\ct)^T & 0 \\ 0 & 0 & 0 & \intrp(\hbst{\cmrcpi{\ct}},\ct)^T \end{bmatrix}}_{ \intrpmat\left(\hbst{\cmrcpi{\ct}},\ct\right) } \underbrace{\begin{bmatrix} \hbwf{1,\cmrcpi{\ct}} \\ \hbwf{2,\cmrcpi{\ct}} \\ \hbwf{3,\cmrcpi{\ct}} \\ \hbwf{4,\cmrcpi{\ct}} \end{bmatrix}}_{\hbwf{\cmrcpi{\ct}}} \nonumber      .
\end{IEEEeqnarray}

Measurements are denoted $\ob{\ti}$ (as in the general framework) and are modelled as noisy observations of the heartbeat signal,
%
\begin{IEEEeqnarray}{rCl}
 \lhood(\ob{\ti} | \hs{}{\ot{\ti}}) & = & \normalden{\ob{\ti}}{\hs{}{\ot{\ti}}}{\hbobscov} \nonumber      .
\end{IEEEeqnarray}

Finally, heartbeat waveform templates are modelled as a Markovian sequence with Gaussian prior and transition densities.
%
\begin{IEEEeqnarray}{rCl}
 p(\hbwf{\si,0}) & = & \normalden{\hbwf{\si,0}}{0}{\hbwfpriorcov} \nonumber \\
 p(\hbwf{\si,\cpi} | \hbwf{\si,\cpi-1}) & = & \normalden{\hbwf{\si,\cpi}}{\hbwf{\si,\cpi-1}}{\hbwftranscov} \nonumber      .
\end{IEEEeqnarray}
%
The prior covariance matrix $\hbwfpriorcov$ is chosen to be diagonal, with very small values at the ends and a larger value in the middle. This reflects our expectation that the waveform should have the greatest amplitude roughly in the middle of the beat. Specifically, we use,
%
\begin{IEEEeqnarray}{rCl}
 \hbwfpriorcov_{i,i} & = & \sigma_{\omega}^2 \times \half \left( 1-\cos\left( \frac{ 2 \pi i }{ \hbwflen+1 } \right) \right)^2 \nonumber      .
\end{IEEEeqnarray}
%
The transition covariance matrix $\hbwftranscov$ is the identity multiplied by a small positive constant.

This model fits exactly into the framework laid out in section~\ref{}{\meta Add ref.}, using a single sequence of changepoints with the following correspondence,
%
\begin{IEEEeqnarray}{rCl}
 \cpt{\cpi} & = & \hbst{\cpi} \nonumber \\
 \cpp{\cpi} & = & \hbmd{\cpi} \nonumber \\
 \cplp{\cpi} & = & \hbwf{\cpi} \nonumber \\
 \cls{\ct} & = & \hs{}{\ct} \nonumber       .
\end{IEEEeqnarray}



\subsection{Variations on the Basic Model}

\subsubsection{Simplifying Waveform Template Estimation}

If only a short section of data is to be studied, then it may be valid to assume that the waveform template is constant for every beat. In this case, it is only necessary to specify a prior,
%
\begin{IEEEeqnarray}{rCl}
 p(\hbwf{\si}) & = & \normalden{\hbwf{\si}}{0}{\hbwfpriorcov} \nonumber       .
\end{IEEEeqnarray}
%
The algorithm proceeds as before except that all Kalman filter prediction steps are omitted when calculating the waveform template conditional posterior distributions. With this modification, we now have,
%
\begin{IEEEeqnarray}{rCl}
 \cplp{\cpi} & = & \hbwf{} \nonumber      .
\end{IEEEeqnarray}
%
This simply entails setting $\cplptransmat = I$ and $\cplptranscov = 0$.



\subsubsection{A Smoother Likelihood Function}

As formulated, the observation density for the $(\ti)$th observation is not a smooth function of the changepoint sequence; it contains a jump at the point $\ot{\ti}=\cpt{\dmrcpi{\ti}}$, as the observation is shifted from one heartbeat to the next. This is problematic for gradient ascent algorithms seeking a peak in the likelihood function. To alleviate this problem, we use a window function to smoothly taper between the heartbeats,
%
\begin{IEEEeqnarray}{rCl}
 \hs{\si}{\ct} & = & \begin{cases} \left[1-\window\left(\frac{\ct-\hbst{\cmrcpi{\ct}}}{\period}\right)\right] \intrp(\hbst{\cmrcpi{\ct}-1},\ct) \cdot \hbwf{\si,\cmrcpi{\ct}-1} & \\
 \qquad  + \window\left(\frac{\ct-\hbst{\cmrcpi{\ct}}}{\period}\right) \intrp(\hbst{\cmrcpi{\ct}},\ct) \cdot \hbwf{\si,\cmrcpi{\ct}} & \hbst{\cmrcpi{\ct}} < \ct \leq \hbst{\cmrcpi{\ct}} + \period \\
 \intrp(\hbst{\cmrcpi{\ct}},\ct) \cdot \hbwf{\si,\cmrcpi{\ct}} & \hbst{\cmrcpi{\ct}} + \period < \ct < \hbst{\cmrcpi{\ct}+1}
 \end{cases} \nonumber      ,
\end{IEEEeqnarray}
%
where $\window(\ct)$ is a monotonically non-decreasing function with $\window(0)=0$ and $\window(1)=1$ and with zero gradient at both $\ct=0$ and $\ct=1$. For example,
%
\begin{IEEEeqnarray}{rCl}
 \window(t) & = & \half\left[1 - \cos(\pi t)\right] \nonumber      .
\end{IEEEeqnarray}

Because of the overlap between the heartbeats, the latent state may now depend on the preceding two heartbeat waveforms. Therefore, in order for this model to adhere to the framework set out in section~\ref{}{\meta Add ref.}, we now use,
%
\begin{IEEEeqnarray}{rCl}
 \cplp{\cpi} & = & \begin{bmatrix} \hbwf{\cpi} \\ \hbwf{\cpi-1} \end{bmatrix} \nonumber      ,
\end{IEEEeqnarray}
%
along with the obvious augmentations of the interpolation matrix $\transfun$ and linear parameter matrixes $\cplptransmat$ and $\cplptranscov$.



\subsection{Modelling Heartbeat Combinations}

When there are two people sleeping in the bed, the heartbeat signals are assumed to be independent a priori. (An interesting question is whether this assumption is valid --- will heartbeat rhythms ever ``sync up''?) Thus, we have two sequences of heartbeat start times, minimum durations and waveform templates,
%
\begin{IEEEeqnarray}{rCl}
 \left\{ \hbst[\peri]{\cpi}, \hbmd[\peri]{\cpi}, \hbwf[\peri]{\cpi} \right\} \: \peri=1,2 \nonumber      .
\end{IEEEeqnarray}
%
There are also two noise-free heartbeat signals $\hs[\peri]{}{\ct}, \: \peri=1,2$ each determined by its respective sequence using \eqref{} or \eqref{}{\meta Add refs}. The measurements are modelled as noisy observations of the sum of these signals. This model again fits into the framework laid out in section~\ref{}{\meta Add ref}, now with two changepoint sub-sequences,
%
\begin{IEEEeqnarray}{rCl}
 \cpt[\sqi]{\cpi} & = & \hbst[\sqi]{\cpi}, \: \sqi = 1,2 \nonumber \\
 \cpp[\sqi]{\cpi} & = & \hbmd[\sqi]{\cpi}, \: \sqi = 1,2 \nonumber \\
 \cplp[\sqi]{\cpi} & = & \hbwf[\sqi]{\cpi} \quad\text{or}\quad \begin{bmatrix} \hbwf[\sqi]{\cpi} \\ \hbwf[\sqi]{\cpi-1} \end{bmatrix} \quad\text{or}\quad \hbwf[\sqi]{}, \: \sqi = 1,2 \nonumber \\
 \cls{\ct} & = & \hs[1]{}{\ct} + \hs[2]{}{\ct} \nonumber       .
\end{IEEEeqnarray}







\subsection{Modelling Clutter and Interference}

\subsection{Importance Distribution for Changepoint Sequences}

For the heartbeat inference problem investigated in this paper, the observations are highly informative (high dimension and low noise), and therefore it is vital to propose heartbeat sequences close to peaks in the likelihood. {\meta Graph.} To achieve this, we sample changepoints from the prior but then adjust them by sampling a ``better'' value from a distribution centered on a local maximum of the likelihood. For the two-person model, the procedure follows the following steps,
%
\begin{algorithmic}[1]
  \WHILE{the latest changepoint in both sequences is earlier than the end of the window,}
    \STATE Sample a changepoint parameter and intermediate changepoint time for each sequence from the transition density.
    \STATE Starting with the intermediate times, deterministically optimise to find a nearby local maximum of the likelihood in the 2D space spanned by the latest changepoint time in each sequence.
    \STATE Sample a final value for these two latest changepoint times from a joint density centered on the local maximum.
    \STATE Discard the intermediate changepoint times.
  \ENDWHILE
  \WHILE{the latest changepoint in either sequence is earlier than the end of the window,}
    \STATE Sample a changepoint parameter and intermediate changepoint time for the remaining sequence from the transition density.
    \STATE Starting with the intermediate time, deterministically optimise to find a nearby local maximum of the likelihood in the 1D space spanned by the latest changepoint time the remaining each sequence.
    \STATE Sample a final value for the latest changepoint time from a density centered on the local maximum.
    \STATE Discard the intermediate changepoint time.
  \ENDWHILE
  \STATE The last changepoint in each sequence, which occur after the end of the window, are discarded.
\end{algorithmic}

We can write the distribution sampled by this procedure as follows (assuming $\dmrcpi[2]{\ti_2} - \dmrcpi[2]{\ti_1} \geq \dmrcpi[1]{\ti_2} - \dmrcpi[1]{\ti_1}$, switch the indexes if this is not the case),
%
\begin{IEEEeqnarray}{l}
 \impden{\ti}{\ti+\winlen}(\cp[\ti]{\ti+\winlen} | \cp{\ti-\blocklen+\winlen}) = \prod_{\sqi}\left[ \frac{ \survfunc[\sqi]{\cpt[\sqi]{\dmrcpi[\sqi]{\ti_2}}}{\cpp[\sqi]{\dmrcpi[\sqi]{\ti_2}}}{\ot{\ti_2}} }{ \survfunc[\sqi]{\cpt[\sqi]{\dmrcpi[\sqi]{\ti_1}}}{\cpp[\sqi]{\dmrcpi[\sqi]{\ti_1}}}{\ot{\ti_1}} } \right] \nonumber \\
 \qquad  \times \prod_{l=1}^{\diffcpi{1}} \left[\prod_{\sqi} \transden[\sqi]{\cpt{},\cpp{}}\left(\tmpcpt[\sqi]{\dmrcpi[\sqi]{\ti_1}+l}, \cpp[\sqi]{\dmrcpi[\sqi]{\ti_1}+l} \left| \cpt[\sqi]{\dmrcpi[\sqi]{\ti_1}+l-1}, \cpp[\sqi]{\dmrcpi[\sqi]{\ti_1}+l-1}\right.\right) \right] \adjden \left( \cpt[1]{\dmrcpi[\sqi]{\ti_1}+l}, \cpt[\sqi]{\dmrcpi[2]{\ti_1}+l} \left| \tmpcpt[1]{\dmrcpi[\sqi]{\ti_1}+l}, \tmpcpt[2]{\dmrcpi[\sqi]{\ti_1}+l} \right.\right) \nonumber \\
 \qquad  \times \prod_{l=\diffcpi{1}+1}^{\diffcpi{2}} \transden[2]{\cpt{},\cpp{}}\left(\tmpcpt[2]{\dmrcpi[2]{\ti_1}+l}, \cpp[2]{\dmrcpi[2]{\ti_1}+l} \left| \cpt[2]{\dmrcpi[2]{\ti_1}+l-1}, \cpp[2]{\dmrcpi[2]{\ti_1}+l-1}\right.\right) \adjden \left( \cpt[\sqi]{\dmrcpi[2]{\ti_1}+l} \left| \tmpcpt[2]{\dmrcpi[\sqi]{\ti_1}+l} \right.\right)
\end{IEEEeqnarray}
%
where $\diffcpi{\sqi} = \dmrcpi[\sqi]{\ti_2} - \dmrcpi[\sqi]{\ti_1}$, and $\adjden$ is the chosen density for the final changepoint times. For our simulations, a Gaussian was used, with mean at the located local maximum and variance equal to the Hessian of the log-likelihood at this point.
{\meta Oh wow. Epic!}

In order to avoid intractable integrals, the intermediate states, $\{\tmpcpt[\sqi]{\dmrcpi[\sqi]{\cpi}}\}$ are included in the target distribution by adding an additional artificial density,
%
\begin{IEEEeqnarray}{rCl}
 p(\cp{\ti}, \repcp[\ti]{\ti+\winlen} | \ob{1:\ti+\winlen}) \artden{\ti}{\ti-\blocklen+\winlen}( \cp[\ti]{\ti-\blocklen+\winlen} | \cp{\ti}, \repcp[\ti]{\ti+\winlen}) \tmpden( \{\tmpcpt[\sqi]{\dmrcpi[\sqi]{\cpi}}\} | \cp{\ti}, \repcp[\ti]{\ti+\winlen} ) \nonumber      .
\end{IEEEeqnarray}
%
Setting $\tmpden$ to the product of transition densities for the intermediate changepoints conditioned on the preceding changepoint sequence and sampled parameters, the particle weight is,
%
\begin{IEEEeqnarray}{rCl}
 \pw{\ti}\pss{i} & \propto & \frac{ \lhood(\ob{\ti+1:\ti+\winlen} | \cp{\ti}\pss{i}, \repcp[\ti]{\ti+\winlen}\pss{i}, \ob{1:\ti}) }{ \lhood(\ob{\ti+1:\ti-\blocklen+\winlen} | \cp{\ti-\blocklen+\winlen}\pss{i}, \ob{1:\ti}) } \nonumber \\
 \qquad & & \times \frac{ \prod_{\sqi} \prod_{\cpi=\dmrcpi[\sqi]{\ti_1}+1}^{\dmrcpi[\sqi]{\ti_2}} \transden[\sqi]{\cpt{}}(\cpt[\sqi]{\cpi} | \cpt[\sqi]{\cpi-1}, \cpp[\sqi]{\cpi-1}) }{ \prod_{l=1}^{\diffcpi{1}} \adjden \left( \cpt[1]{\dmrcpi[\sqi]{\ti_1}+l}, \cpt[\sqi]{\dmrcpi[2]{\ti_1}+l} \left| \tmpcpt[1]{\dmrcpi[\sqi]{\ti_1}+l}, \tmpcpt[2]{\dmrcpi[\sqi]{\ti_1}+l} \right.\right) \prod_{l=\diffcpi{1}+1}^{\diffcpi{2}} \adjden \left( \cpt[\sqi]{\dmrcpi[2]{\ti_1}+l} \left| \tmpcpt[2]{\dmrcpi[\sqi]{\ti_1}+l} \right.\right) } \nonumber       .
\end{IEEEeqnarray}



\section{Implementation and Testing}


\bibliographystyle{dcu}
\bibliography{D:/pb404/Dropbox/PhD/Cleanbib}
\end{document} 